<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>StockAgent – AI Market Intelligence</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      /* Modern Fintech Palette */
      --primary: #0f172a;       /* Slate 900 */
      --primary-light: #1e293b; /* Slate 800 */
      --accent: #3b82f6;        /* Blue 500 */
      --accent-glow: rgba(59, 130, 246, 0.15);
      
      --bg-body: #f8fafc;       /* Slate 50 */
      --bg-card: #ffffff;
      
      --text-main: #1e293b;
      --text-muted: #64748b;
      
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      
      --border: #e2e8f0;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }

    /* --- Header --- */
    .header {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-decoration: none;
      color: var(--primary);
    }
    
    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary) 0%, #334155 100%);
      color: white;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.25rem;
      box-shadow: var(--shadow-sm);
    }
    
    .logo-text {
      font-weight: 700;
      font-size: 1.25rem;
      letter-spacing: -0.025em;
    }

    /* Status Dot Pulse Animation */
    .status-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-muted);
      box-shadow: var(--shadow-sm);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      background-color: var(--success);
      border-radius: 50%;
      position: relative;
    }
    
    .status-dot::after {
      content: '';
      position: absolute;
      top: -4px; left: -4px; right: -4px; bottom: -4px;
      background-color: rgba(16, 185, 129, 0.2);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(2); opacity: 0; }
    }

    /* --- Main Layout --- */
    .main {
      flex: 1;
      max-width: 1000px;
      width: 100%;
      margin: 0 auto;
      padding: 3rem 1.5rem;
    }

    /* Hero Section */
    .hero {
      text-align: center;
      margin-bottom: 3rem;
      animation: fadeIn 0.8s ease-out;
    }

    .hero h1 {
      font-size: 3.5rem;
      font-weight: 800;
      line-height: 1.1;
      margin-bottom: 1rem;
      letter-spacing: -0.03em;
      color: var(--primary);
    }
    
    .hero h1 span {
      background: linear-gradient(135deg, var(--accent) 0%, #60a5fa 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .hero p {
      font-size: 1.25rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto;
    }

    /* Search Bar */
    .search-container {
      background: var(--bg-card);
      padding: 0.75rem;
      border-radius: 16px;
      box-shadow: var(--shadow-lg);
      display: flex;
      gap: 0.5rem;
      max-width: 700px;
      margin: 0 auto 1rem;
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .search-container:focus-within {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      border-color: var(--accent);
    }

    .ticker-input {
      flex: 1;
      border: none;
      font-size: 1.125rem;
      padding: 0 1.5rem;
      outline: none;
      font-family: inherit;
      color: var(--primary);
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .ticker-input::placeholder {
      color: #94a3b8;
      text-transform: none;
      font-weight: 400;
    }

    .btn-search {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 10px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .btn-search:hover { background: var(--primary-light); }
    .btn-search:disabled { opacity: 0.7; cursor: not-allowed; }

    /* --- Result Card --- */
    .result-card {
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      margin-top: 3rem;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.5s ease-out;
    }

    .result-card.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .card-header {
      padding: 1.5rem 2rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8fafc;
    }
    
    .card-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Verdict Badge */
    .verdict-badge {
      font-size: 0.875rem;
      font-weight: 700;
      padding: 0.5rem 1.25rem;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      box-shadow: var(--shadow-sm);
    }
    
    .badge-buy { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
    .badge-sell { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
    .badge-hold { background: #fef3c7; color: #b45309; border: 1px solid #fde68a; }
    .badge-wait { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }

    /* Chart Area - UPDATED: REMOVED ANIMATION TRANSITION */
    .chart-container {
      width: 100%;
      height: 0;
      overflow: hidden;
      /* transition: height 0.3s ease;  <-- REMOVED THIS LINE TO FIX SQUASHING */
      background: white;
      border-bottom: 1px solid var(--border);
      display: none; /* Initially hidden */
    }
    .chart-container.active { 
        display: block; 
        height: auto; 
    }

    /* Analysis Text */
    .analysis-content { padding: 2.5rem; font-size: 1rem; color: var(--text-main); }
    
    .analysis-content h3 {
      font-size: 1.15rem;
      color: var(--primary);
      margin-top: 2rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border);
    }
    
    .analysis-content h3:first-child { margin-top: 0; }
    
    .analysis-content ul { padding-left: 1.5rem; margin-bottom: 1.5rem; }
    .analysis-content li { margin-bottom: 0.5rem; color: var(--text-muted); }
    .analysis-content strong { color: var(--primary); font-weight: 600; }

    /* Disclaimer */
    .disclaimer {
      margin: 2rem 2.5rem;
      padding: 1rem;
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-radius: 8px;
      font-size: 0.8rem;
      color: #92400e;
      text-align: center;
      line-height: 1.5;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-top: auto;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

    /* Responsive */
    @media (max-width: 640px) {
      .hero h1 { font-size: 2.5rem; }
      .search-container { flex-direction: column; padding: 1rem; }
      .ticker-input { text-align: center; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-content">
      <a href="/" class="logo">
        <div class="logo-icon">S</div>
        <span class="logo-text">StockAgent</span>
      </a>
      <div class="status-badge">
        <div class="status-dot"></div>
        <span>System Online</span>
      </div>
    </div>
  </header>

  <main class="main">
    
    <section class="hero">
      <h1>Market <span>Intelligence</span></h1>
      <p>Institutional-grade analysis powered by AI & Algorithms.</p>
    </section>

    <div class="search-container">
      <input 
        id="ticker-input" 
        class="ticker-input" 
        type="text" 
        placeholder="Enter Ticker (e.g. NVDA)" 
        autocomplete="off"
      >
      <button id="analyze-btn" class="btn-search">Run Analysis</button>
    </div>
    
    <div id="status-msg" style="text-align:center; color: var(--text-muted); height: 20px; font-size: 0.9rem;"></div>

    <article class="result-card" id="result-card">
      <div class="card-header">
        <div class="card-title">
          <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          Analyst Report
        </div>
        <div id="verdict-badge" class="verdict-badge badge-wait">Awaiting Input</div>
      </div>

      <div id="chart-div" class="chart-container"></div>

      <div class="analysis-content" id="analysis-text">
        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
          Enter a stock ticker above to generate a full fundamental & technical report.
        </div>
      </div>

      <div class="disclaimer">
        <strong>⚠️ DISCLAIMER:</strong> This report is AI-generated for educational purposes only. It is NOT financial advice. Always consult a certified professional before investing.
      </div>
    </article>

  </main>

  <footer class="footer">
    Built with <strong>FastAPI</strong>, <strong>Ollama</strong>, <strong>Plotly</strong> & <strong>Pandas</strong>
  </footer>

  <script>
    const tickerInput = document.getElementById("ticker-input");
    const analyzeBtn = document.getElementById("analyze-btn");
    const analysisText = document.getElementById("analysis-text");
    const verdictBadge = document.getElementById("verdict-badge");
    const statusMsg = document.getElementById("status-msg");
    const chartDiv = document.getElementById("chart-div");
    const resultCard = document.getElementById("result-card");

    // Make card visible on load for visual structure
    setTimeout(() => resultCard.classList.add('visible'), 300);

    function formatMarkdown(text) {
        if (!text) return "";
        return text
            .replace(/\*\*/g, "") 
            .replace(/^### (.*$)/gim, '<h3>$1</h3>') 
            .replace(/^## (.*$)/gim, '<h3>$1</h3>')
            .replace(/^[-*] (.*$)/gim, '<ul><li>$1</li></ul>') 
            .replace(/\n/gim, '<br />'); 
    }

    function renderChart(data, ticker) {
      if (!data || !data.dates || data.dates.length === 0) {
        chartDiv.classList.remove("active");
        return;
      }
      
      chartDiv.classList.add("active");
      
      const trace = {
        x: data.dates,
        close: data.close,
        decreasing: {line: {color: '#ef4444'}},
        high: data.high,
        increasing: {line: {color: '#10b981'}},
        line: {color: '#1e293b'},
        low: data.low,
        open: data.open,
        type: 'candlestick', 
        xaxis: 'x', 
        yaxis: 'y'
      };

      const layout = {
        title: { text: `${ticker} • 1 Year Price Action`, font: { size: 14 } },
        dragmode: 'zoom', 
        showlegend: false, 
        font: { family: 'Inter, sans-serif' },
        xaxis: { rangeslider: { visible: false }, gridcolor: '#f1f5f9' },
        yaxis: { gridcolor: '#f1f5f9' },
        margin: { r: 40, t: 40, b: 40, l: 40 },
        height: 500, // <--- EXPLICIT HEIGHT FIX
        plot_bgcolor: "white",
        paper_bgcolor: "white"
      };

      Plotly.newPlot('chart-div', [trace], layout, {responsive: true});
    }

    function setVerdictStyle(verdict) {
      verdictBadge.className = "verdict-badge"; // Reset
      if (verdict === "BUY") verdictBadge.classList.add("badge-buy");
      else if (verdict === "SELL") verdictBadge.classList.add("badge-sell");
      else if (verdict === "HOLD") verdictBadge.classList.add("badge-hold");
      else verdictBadge.classList.add("badge-wait");
      
      verdictBadge.textContent = verdict || "Ready";
    }

    async function handleAnalyze() {
      const ticker = tickerInput.value.trim().toUpperCase();
      if (!ticker) return;

      statusMsg.textContent = `Gathering data for ${ticker}... (Price, News, Fundamentals)`;
      analyzeBtn.disabled = true;
      chartDiv.classList.remove("active"); // Hide old chart
      setVerdictStyle("PROCESSING...");
      
      analysisText.innerHTML = `
        <div style="display:flex; justify-content:center; padding:3rem;">
           <div class="status-dot" style="width:12px; height:12px; background:var(--accent);"></div>
        </div>
      `;

      try {
        const res = await fetch("/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ticker }),
        });

        if (!res.ok) throw new Error("Analysis failed");
        const data = await res.json();

        // 1. Render Text
        analysisText.innerHTML = formatMarkdown(data.analysis || "");
        
        // 2. Render Verdict
        const match = (data.analysis || "").match(/Verdict:\s*(BUY|SELL|HOLD)/i);
        if (match && match[1]) {
            setVerdictStyle(match[1].toUpperCase());
        } else {
            setVerdictStyle("INSIGHTS");
        }

        // 3. Render Chart
        if (data.chart_data) {
          renderChart(data.chart_data, ticker);
        }

        statusMsg.textContent = `Analysis complete for ${ticker}`;
      } catch (err) {
        statusMsg.textContent = "Error: " + err.message;
        setVerdictStyle("ERROR");
        analysisText.innerHTML = `<div style="color:var(--error); text-align:center;">${err.message}</div>`;
      } finally {
        analyzeBtn.disabled = false;
      }
    }

    analyzeBtn.addEventListener("click", handleAnalyze);
    tickerInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleAnalyze();
    });
  </script>
</body>
</html>